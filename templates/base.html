<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  <!-- ğŸ“± Permet lâ€™adaptation mobile -->
    <link rel="icon" type="image/jpeg" href="{{ url_for('static', filename='kro.png') }}">
    <title>Caps Ranking</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">  <!-- ğŸ“Œ Bootstrap -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-danger">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <img src="{{ url_for('static', filename='kro2.png') }}" alt="Caps Royale" class="logo-img">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="/profile">Profil</a></li>
                    <li class="nav-item"><a class="nav-link" href="/ranking">Classement</a></li>
                    <li class="nav-item"><a class="nav-link" href="/declare_match">DÃ©clarer un Match</a></li>
                    <li class="nav-item"><a class="nav-link" href="/notifications">Notifications</a></li>
                    <div id="search-container">
                        <!-- Les champs joueurs seront gÃ©nÃ©rÃ©s ici par JavaScript -->
                    </div>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1 class="page-title">Caps Royale</h1>
        {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const searchContainer = document.getElementById("search-container");
    searchContainer.innerHTML = "";  // ğŸ”¥ On s'assure que le conteneur est vide avant d'ajouter les Ã©lÃ©ments

    const label = document.createElement("label");
    label.textContent = "Rechercher un joueur :";

    const input = document.createElement("input");
    input.type = "text";
    input.id = "search-player";
    input.autocomplete = "off";
    input.classList.add("form-control");
    input.setAttribute("onkeyup", "researchUsers(event, this, 'players-list')");
    input.setAttribute("onblur", "validateSearch(this, 'players-list')");

    const datalist = document.createElement("datalist");
    datalist.id = "players-list";

    input.setAttribute("list", datalist.id);

    const button = document.createElement("button");
    button.textContent = "ğŸ”";
    button.classList.add("btn", "btn-primary", "ms-2");  // ğŸ”¥ Style Bootstrap
    button.onclick = function () {
        validateAndSearch();
    };

searchContainer.appendChild(label);
searchContainer.appendChild(input);
searchContainer.appendChild(datalist);
searchContainer.appendChild(button);  // âœ… Ajout du bouton de validation
    

function researchUsers(event, inputField, datalistId) {
    const query = inputField.value.trim();
    if (query.length < 1) return;

    fetch(`/search_users?q=${query}`)
        .then(response => response.json())
        .then(data => {
            const datalist = document.getElementById(datalistId);
            datalist.innerHTML = "";  // ğŸ”¥ Efface les anciennes options

            data.forEach(user => {
                const option = document.createElement("option");
                option.value = user.username;
                option.dataset.id = user.id;  // âœ… Stocke l'ID du joueur
                datalist.appendChild(option);
            });
        });
}

function validateSearch(inputField, datalistId) {
    const datalist = document.getElementById(datalistId);
    const options = Array.from(datalist.options).map(opt => opt.value);

    if (!options.includes(inputField.value)) {
        inputField.value = "";
        alert("Veuillez sÃ©lectionner un joueur existant !");
    }
}



function validateAndSearch() {
    const inputField = document.getElementById("search-player");
    const datalist = document.getElementById("players-list");
    const options = Array.from(datalist.options);

    // ğŸ”¥ Trouver l'ID correspondant au username sÃ©lectionnÃ©
    let selectedUser = options.find(opt => opt.value === inputField.value);
    if (!selectedUser || !selectedUser.dataset.id) {
        alert("Veuillez sÃ©lectionner un joueur existant !");
        return;
    }

    const userId = selectedUser.dataset.id;  // ğŸ”¥ RÃ©cupÃ©ration de l'ID
    window.location.href = `/profile/${userId}`;
}
    </script>

    <footer class="footer">
        <p>Projet dÃ©veloppÃ© par : <strong>Ã‘okaka- V45</strong> et l'Ã©quipe Caps Royale ğŸ»</p>
    </footer>
</body>
</html>